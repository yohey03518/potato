# Feature Specification: 台股自動交易模擬系統 (Taiwan Stock Trading Sim)

**Feature Branch**: `001-stock-trading-sim`  
**Created**: 2026-01-13  
**Status**: Draft  
**Input**: User description: "Taiwan Stock Automated Trading System and Simulation" (from requirement-prompt.md)
**LANGUAGE CONSTRAINT**: All content generated using this template MUST be written in Traditional Chinese.

## User Scenarios & Testing *(mandatory)*

## Clarifications

### Session 2026-01-13
- Q: 系統的行情數據來源為何？ → A: 使用真實的 Live 交易資料（具體 API 於規劃階段確認）。
- Q: 使用者如何監控系統運行狀態與查看訊號？ → A: 使用 CLI / Terminal UI（終端機介面）。
- Q: 交易紀錄與行情資料的儲存方式為何？ → A: 推遲至規劃階段決定（Deferred to Planning）。
- Q: 策略的停損與停利邏輯為何？ → A: 複合式邏輯：(1) 進場前檢查停損距離若 >5% 則放棄；(2) 獲利達 5% 時先平倉 50%；(3) 其餘部位依策略訊號（跌破20MA、收盤強平、漲跌停）出場。
- Q: 如何決定每日的「觀察標的清單」？ → A: 自動選股策略：系統每日開盤前依據前日數據自動篩選符合條件的股票。

### User Story 1 - 策略監控與訊號觸發 (Priority: P1)

系統需在盤中即時監控觀察名單中的股票，根據設定的「簡單策略」（日K趨勢與5分K進出）判斷買賣點並發出訊號。這是整個系統的核心大腦。

**Why this priority**: 若無法正確產生訊號，後續的下單與模擬皆無意義。

**Independent Test**: 透過輸入歷史或模擬的股價數據流，驗證系統是否能在特定K線形態出現時（如股價站上20-5分K），立即產生對應的買入或賣出訊號。

**Acceptance Scenarios**:

1. **Given** 股票昨日收盤價高於月均線（符合做多觀察條件）, **And** 預估停損點距離當前價格 < 5%, **When** 今日盤中5分K收盤價由下往上突破20MA（5分月K）, **Then** 系統應產生「買入」訊號。
2. **Given** 預估停損點距離當前價格 > 5%, **When** 策略訊號出現, **Then** 系統應忽略該訊號，不執行下單。
3. **Given** 持有多單部位, **When** 盤中5分K收盤價由上往下及跌破20MA, **Then** 系統應產生「賣出」訊號（清空剩餘部位）。
4. **Given** 股票昨日收盤價低於月均線（符合做空觀察條件）, **When** 今日盤中5分K收盤價由上往下跌破20MA, **Then** 系統應產生「放空」訊號。
5. **Given** 5分K線尚未收盤（時間未到）, **When** 盤中價格暫時穿越20MA, **Then** 系統不應產生任何訊號（需等待K線確認）。
6. **Given** 持有部位獲利達到 5%, **When** 市場價格觸及該目標, **Then** 系統應立即產生「部分停利」訊號，平倉 50% 持股。

---

### User Story 2 - 擬真撮合模擬 (Priority: P1)

收到交易訊號後，系統需模擬下單行為。根據當下市場的五檔掛單（最佳五檔買賣價量）記錄排隊順序，並依據後續真實成交的價格與單量，判定模擬單是否成交。

**Why this priority**: 為了驗證策略的有效性，必須有貼近真實市場的成交模擬，而非僅以「見價即成交」的過度樂觀方式回測。

**Independent Test**: 模擬掛出一張限價單，接著輸入一系列市場成交資料（Tick Data），驗證系統是否在市場成交量累積超過排隊量後才標記為「成交」。

**Acceptance Scenarios**:

1. **Given** 發出限價買單, **When** 當下市場賣一價格高於委託價（需排隊）, **Then** 系統記錄當前委託單在買盤中的排隊順序（根據即時五檔掛單量）。
2. **Given** 委託單處於排隊狀態, **When** 市場後續成交價格等於委託價且累積成交量超過排隊順序, **Then** 系統判定該模擬單成交，並記錄成交時間與價格。
3. **Given** 發出市價單（或模擬現價吃單）, **When** 市場有足夠流動性, **Then** 系統應以當下最佳對手價模擬成交。

---

### User Story 3 - 當沖強迫平倉 (Priority: P2)

為符合當沖交易規則，若接近收盤時（如收盤前5分鐘）仍有未平倉部位，系統需強制掛單出清，避免留倉風險。

**Why this priority**: 風險控制機制，確保當沖策略不會演變為意外的波段留倉。

**Independent Test**: 設定系統時間快轉至 13:25，檢查系統是否針對持有部位自動發出反向平倉單。

**Acceptance Scenarios**:

1. **Given** 帳號仍持有未平倉部位（多單或空單）, **When** 時間到達收盤前5分鐘（13:25）, **Then** 系統自動發出漲停價（回補空單）或跌停價（賣出多單）的平倉委託，確保成交。

---

### User Story 4 - 交易紀錄保存 (Priority: P3)

系統需完整保存每一筆交易的生命週期，供工程人員或分析師後續查核與績效分析。

**Why this priority**: 數據是優化策略的基礎，需確保資料可追溯。

**Independent Test**: 執行一系列模擬交易後，查詢資料庫確認資料是否完整寫入。

**Acceptance Scenarios**:

1. **Given** 一筆委託單經歷下單、排隊、成交（可能分批成交）, **When** 交易完成, **Then** 資料庫應存有完整的紀錄，包含：下單時間、委託價格、排隊順序、實際成交時間、成交價格。

---

### Edge Cases

- What happens when 市場數據中斷或延遲？（系統應暫停策略判斷，避免錯誤訊號）
- How does system handle 漲跌停鎖死導致無法平倉？（模擬系統應記錄無法成交的狀態，並在日結報告中警示）
- How does system handle 盤中瞬間巨量導致的滑價（Slippage）？（應透過擬真撮合邏輯，以實際撮合到的價格為準，而非僅以觸發價成交）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須能依據前日數據與選股規則（如收盤價與月線關係）「自動產生」每日觀察標的清單。
- **FR-002**: 系統必須能透過 API 接收台股即時行情數據（Live Market Data），包含 Tick（逐筆成交）、Bid/Ask（五檔掛單）與 KLine（K線資料）。
- **FR-003**: 系統必須依據即時報價計算「5分鐘K線」及其「20期移動平均線（20MA）」。
- **FR-004**: 系統必須實作「日K線過濾邏輯」：依據昨日收盤價與月均線關係，決定今日僅做多或僅做空。
- **FR-005**: 系統必須實作「5分K進出策略」：K線收盤確認站上或跌破 20MA 時觸發對應訊號。
- **FR-006**: 系統必須支援「模擬下單」，包含市價單與限價單。
- **FR-007**: 系統必須實作「排隊撮合演算法」，依據下單當下的五檔掛單量計算排隊順序，並依據後續 Tick 資料判定成交。
- **FR-008**: 系統必須在每日 13:25（收盤前5分鐘）觸發「強制平倉機制」，以極端價格（漲/跌停）出清所有當沖部位。
- **FR-009**: 系統必須將所有交易事件（訊號、委託、成交）寫入資料庫或持久化儲存。
- **FR-010**: 系統必須提供一個 CLI / Terminal UI，用於顯示即時行情、策略狀態、訊號觸發紀錄與目前持倉。
- **FR-011**: 系統必須實作複合式風控邏輯：(1) 進場前檢查潛在停損幅度（不得 > 5%）；(2) 獲利達 5% 時觸發 50% 部分平倉；(3) 剩餘部位依技術訊號或收盤強平出場。

### Key Entities *(include if feature involves data)*

- **MarketTick (行情Tick)**: 股票代號、時間、成交價、成交量、五檔買賣價量。
- **KLine (K線)**: 股票代號、週期(5分/日)、開盤價、最高價、最低價、收盤價、時間、MA值。
- **StrategyContext (策略情境)**: 股票代號、當日方向(做多/做空/觀望)、目前持倉狀態。
- **Order (委託單)**: 委託ID、股票代號、買賣別、價格、數量、類型(市價/限價)、下單時間、狀態。
- **Execution (成交紀錄)**: 成交ID、委託ID、成交價格、成交數量、成交時間。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 策略訊號準確度：在 5分K線 收盤確認後的 1 秒內，系統必須完成指標計算並發出對應訊號。
- **SC-002**: 模擬撮合邏輯正確性：在重播相同的歷史 Tick 數據時，系統的買賣點與成交價格必須完全一致（Deterministic）。
- **SC-003**: 系統穩定性：能同時對至少 10 檔股票進行即時策略運算與模擬撮合，無顯著延遲（Tick處理延遲 < 100ms）。
- **SC-004**: 資料完整性：100% 的委託與成交紀錄皆被正確儲存，無資料遺失。